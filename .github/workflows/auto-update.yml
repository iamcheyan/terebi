name: å®šæ—¶æ›´æ–°é¢‘é“æ•°æ®

# å®šæ—¶è§¦å‘ - æ¯å¤©ä¸œäº¬æ—¶é—´ 00:00 æ‰§è¡Œï¼ˆUTC æ—¶é—´ 15:00ï¼‰
on:
  schedule:
    # cron è¡¨è¾¾å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
    # è¿™é‡Œè®¾ç½®ä¸ºæ¯å¤© UTC 15:00ï¼ˆå³ä¸œäº¬æ—¶é—´ 00:00 JSTï¼‰
    - cron: '0 15 * * *'
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¢‘é“'
        required: false
        type: boolean
        default: false

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. é…ç½® API Keyï¼ˆä»ä»“åº“ Secrets ä¸­è¯»å–ï¼‰
      - name: é…ç½® YouTube API Key
        run: |
          mkdir -p WEB-INF
          echo "[DEFAULT]" > WEB-INF/config.properties
          echo "# YouTube API é…ç½®" >> WEB-INF/config.properties
          echo "youtube.apikey1=${{ secrets.YOUTUBE_API_KEY_1 }}" >> WEB-INF/config.properties
          echo "youtube.apikey2=${{ secrets.YOUTUBE_API_KEY_2 }}" >> WEB-INF/config.properties
          echo "youtube.apikey3=${{ secrets.YOUTUBE_API_KEY_3 }}" >> WEB-INF/config.properties
          echo "youtube.apikey4=${{ secrets.YOUTUBE_API_KEY_4 }}" >> WEB-INF/config.properties
          echo "youtube.apikey5=${{ secrets.YOUTUBE_API_KEY_5 }}" >> WEB-INF/config.properties
      
      # 5. æ‰§è¡Œæ›´æ–°è„šæœ¬
      - name: æ›´æ–°é¢‘é“æ•°æ®
        run: |
          echo "=== å¼€å§‹æ›´æ–°é¢‘é“æ•°æ® ==="
          
          # 1. æŠ“å–é¢‘é“è§†é¢‘
          echo "1. æŠ“å–é¢‘é“è§†é¢‘..."
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            python backend/runner.py fetch --auto-task --videos-per-channel 200 --yes --force
          else
            python backend/runner.py fetch --auto-task --videos-per-channel 200 --yes
          fi
          
          # 2. å¤„ç†æ•°æ®
          echo "2. å¤„ç†æ•°æ®..."
          python backend/runner.py process
          
          # 3. æ›´æ–°ç¼“å­˜æ ‡è®°
          echo "3. æ›´æ–°ç¼“å­˜æ ‡è®°..."
          python backend/runner.py mark
          
          # 4. ä¸‹è½½å¤´åƒ
          echo "4. ä¸‹è½½é¢‘é“å¤´åƒ..."
          python backend/runner.py avatars || echo "å¤´åƒä¸‹è½½å‡ºç°é—®é¢˜ï¼Œç»§ç»­æ‰§è¡Œ"
          
          # 5. è°ƒæ•´å›¾ç‰‡å¤§å°
          echo "5. è°ƒæ•´å›¾ç‰‡å¤§å°..."
          python backend/runner.py resize-logos
          
          # 6. æ¸…ç†æ— æ•ˆé¢‘é“
          echo "6. æ¸…ç†æ— æ•ˆé¢‘é“..."
          python backend/runner.py clear
          
          # 7. æ£€æŸ¥åç§°å·®å¼‚
          echo "7. æ£€æŸ¥åç§°å·®å¼‚..."
          python backend/runner.py check-names
          
          # 8. ç”Ÿæˆæ›´æ–°æ—¥å¿—
          echo "8. ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          python backend/generate_changelog.py
          
          echo "=== é¢‘é“æ›´æ–°å®Œæˆ ==="
      
      # 6. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # è®¾ç½®æ—¶åŒºä¸ºä¸œäº¬æ—¶é—´
          export TZ='Asia/Tokyo'
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S') JST"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
          else
            echo "âœ… æ— æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
      
      # 7. ä¸Šä¼ æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
      - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        if: always()  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: update-logs-${{ github.run_number }}
          path: log/*.log
          retention-days: 7  # ä¿ç•™ 7 å¤©

