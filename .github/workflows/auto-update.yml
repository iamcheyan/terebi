name: å®šæ—¶æ›´æ–°é¢‘é“æ•°æ®

# å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00 æ‰§è¡Œï¼ˆUTC æ—¶é—´ 16:00ï¼‰
on:
  schedule:
    # cron è¡¨è¾¾å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
    # è¿™é‡Œè®¾ç½®ä¸ºæ¯å¤© UTC 16:00ï¼ˆå³åŒ—äº¬æ—¶é—´ 00:00ï¼‰
    - cron: '0 16 * * *'
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¢‘é“'
        required: false
        type: boolean
        default: false

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. é…ç½® API Keyï¼ˆä»ä»“åº“ Secrets ä¸­è¯»å–ï¼‰
      - name: é…ç½® YouTube API Key
        run: |
          mkdir -p WEB-INF
          echo "[DEFAULT]" > WEB-INF/config.properties
          echo "# YouTube API é…ç½®" >> WEB-INF/config.properties
          echo "youtube.apikey1=${{ secrets.YOUTUBE_API_KEY_1 }}" >> WEB-INF/config.properties
          echo "youtube.apikey2=${{ secrets.YOUTUBE_API_KEY_2 }}" >> WEB-INF/config.properties
          echo "youtube.apikey3=${{ secrets.YOUTUBE_API_KEY_3 }}" >> WEB-INF/config.properties
          echo "youtube.apikey4=${{ secrets.YOUTUBE_API_KEY_4 }}" >> WEB-INF/config.properties
          echo "youtube.apikey5=${{ secrets.YOUTUBE_API_KEY_5 }}" >> WEB-INF/config.properties
      
      # 5. æ‰§è¡Œæ›´æ–°è„šæœ¬
      - name: æ›´æ–°é¢‘é“æ•°æ®
        run: |
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            python update.py --auto-task --videos-per-channel 200 --yes --force
          else
            python update.py --auto-task --videos-per-channel 200 --yes
          fi
      
      # 6. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°é¢‘é“æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
          else
            echo "âœ… æ— æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
      
      # 7. ä¸Šä¼ æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
      - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        if: always()  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: update-logs-${{ github.run_number }}
          path: log/*.log
          retention-days: 7  # ä¿ç•™ 7 å¤©

