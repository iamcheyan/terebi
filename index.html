<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Terebi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- 添加 favicon -->
    <link rel="icon" href="static/logo.png" type="image/png">
    
    <!-- iOS 主屏幕图标 -->
    <link rel="apple-touch-icon" href="static/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="static/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="static/logo.png">
    
    <!-- iOS Web App 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Terebi">
    
    <!-- Android Chrome -->
    <meta name="theme-color" content="#1f2937">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=202510192259">
    <script>
        (function() {
            var storageKey = 'preferredTheme';
            var theme = 'dark';
            try {
                var storedTheme = localStorage.getItem(storageKey);
                if (storedTheme === 'light' || storedTheme === 'dark') {
                    theme = storedTheme;
                } else if (window.matchMedia) {
                    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
            } catch (error) {
                console.warn('无法从本地存储读取主题偏好:', error);
            }

            var root = document.documentElement;
            root.dataset.theme = theme;
            root.classList.add('theme-' + theme);
            root.style.colorScheme = theme;
        })();
    </script>

    <!-- 基础样式 - 所有设备都加载 -->
    <link rel="stylesheet" href="styles/main.css?v=202510192259">
    
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="fixed-box">
                <div class="page-header">
    <div class="logo-box">
        <!-- LOGO -->
        <img class="logo" src="static/logo.png" alt="logo">
        <h1>テレビ</h1>
    </div>
        <div class="link-box">
        <!-- 用户账户 -->
        <div class="user-account">
            <button id="loginButton" class="login-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span class="login-text" data-i18n="login">ログイン</span>
            </button>
            <div id="userProfile" class="user-profile" style="display: none;">
                <img id="userAvatar" class="user-avatar" src="" alt="User" style="cursor: pointer;">
                <div id="userMenu" class="user-menu">
                    <div class="user-menu-header">
                        <img id="userAvatarMenu" class="user-avatar-large" src="" alt="User">
                        <div class="user-info">
                            <div id="userNameMenu" class="user-name"></div>
                            <div id="userEmailMenu" class="user-email"></div>
                        </div>
                    </div>
                    <div class="user-menu-divider"></div>
                    <button id="syncDataButton" class="user-menu-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        <span data-i18n="sync_data">同步数据</span>
                    </button>
                    <button id="switchAccountButton" class="user-menu-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span data-i18n="switch_account">切换账户</span>
                    </button>
                    <button id="logoutButton" class="user-menu-item logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span data-i18n="logout">ログアウト</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- <div class="cheyan">
            <a href="https://iamcheyan.com" target="_blank">
                <img src="img/svg/cheyan.jpg" alt="cheyan" width="32" height="32">
            </a>
        </div>
        <div class="git">
            <a class="icon-button" href="https://github.com/iamcheyan/terebi/" target="_blank" title="GitLabでソースコードを見る" aria-label="GitLabでソースコードを見る">
                <svg aria-hidden="true" role="img" class="tanuki-logo" width="32" height="32" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path class="tanuki-shape tanuki" d="m24.507 9.5-.034-.09L21.082.562a.896.896 0 0 0-1.694.091l-2.29 7.01H7.825L5.535.653a.898.898 0 0 0-1.694-.09L.451 9.411.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 2.56 1.935 1.554 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z" fill="#E24329"></path>
                    <path class="tanuki-shape right-cheek" d="m24.507 9.5-.034-.09a11.44 11.44 0 0 0-4.56 2.051l-7.447 5.632 4.742 3.584 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z" fill="#FC6D26"></path>
                    <path class="tanuki-shape chin" d="m7.707 20.677 2.56 1.935 1.555 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935-4.743-3.584-4.755 3.584Z" fill="#FCA326"></path>
                    <path class="tanuki-shape left-cheek" d="M5.01 11.461a11.43 11.43 0 0 0-4.56-2.05L.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 4.745-3.584-7.444-5.632Z" fill="#FC6D26"></path>
                </svg>
            </a>
        </div> -->
        <div class="view-history">
            <button id="viewHistoryButton" class="icon-button" title="視聴履歴" aria-label="視聴履歴">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </button>
        </div>
        <div class="tv-search">
            <button id="tvSearchButton" class="icon-button" title="テレビ番組検索" aria-label="テレビ番組検索">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                    <circle cx="12" cy="8" r="2"></circle>
                </svg>
            </button>
        </div>
        <div class="channel-stats">
            <button id="channelStatsButton" class="icon-button" title="频道统计" aria-label="频道统计">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"></path>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                </svg>
            </button>
        </div>
        <div class="settings">
            <button id="settingsButton" class="icon-button" title="設定" aria-label="設定">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

                <div class="left-column">
                    <div class="box-container">
                    <!-- 播放器容器 -->
                        <div id="playerContainer">
                            <div class="player-loading">
                                <img class="loading-icon" width="24" height="24" src="img/svg/loading.svg" alt="loading">
                                <span>動画を読み込んでいます。しばらくお待ちください...</span>
                            </div>
                            <div id="player"></div>
                        </div>
                        
                        <!-- 清除筛选按钮 -->
                        <button id="clearFilterButton" class="clear-filter-btn" style="display: none;" onclick="clearRegionFilter()">
                            <span class="filter-icon">✕</span>
                            <span class="filter-text">フィルターをクリア</span>
                        </button>
                        
                        <!-- 状态信息移到播放器下方 -->
                        <div id="status">準備完了、チャンネルを読み込んでいます...</div>
                        
                        <div id="videoContainer" class="video-grid" style="display: none;">
                            <!-- 视频卡片将在这里显示 -->
                        </div>
                    </div>
                    
                </div>
                <!-- footer -->
                <footer class="footer">
                    <div class="footer-content">
                        <div class="channel-logo">
                            <img id="currentChannelLogo" src="img/default-logo.png" alt="频道标志">
                        </div>
                        <div class="program-info">
                            <div class="program-title-container">
                                <button id="favoriteVideoBtn" class="favorite-video-btn" title="收藏节目" style="display: none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </button>
                                <a id="currentVideoTitleLink" href="#" target="_blank" class="program-title-link">
                            <span id="currentVideoTitle" class="program-title">未選択</span>
                                </a>
                            </div>
                            <div id="currentChannelName" class="channel-name" style="display: none;">未選択</div>
                            <div id="currentChannelUrl" class="channel-url">https://www.youtube.com/</div>
                        </div>
                        <div class="footer-info">
                            <div class="copyright">
                                <div class="first-line">
                                    <span>非公式YouTubeインデックスツール</span>
                                    
                                </div>
                                <span>著作権は原作者に帰属、保存・配信は行いません</span>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
            <div class="right-column">
                <div class="channel-list-title">チャンネルリスト</div>
                
                <!-- 添加搜索输入框 -->
                <input type="text" id="channelSearch" placeholder="チャンネルを検索..." onkeyup="filterChannels()">
                
                <!-- 全部/收藏切换标签 -->
                <div class="channel-filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="switchChannelFilter('all')">
                        <span class="tab-icon"></span>
                        <span class="tab-text">全て</span>
                    </button>
                    <button class="filter-tab" data-filter="favorites" onclick="switchChannelFilter('favorites')">
                        <span class="tab-icon">⭐</span>
                        <span class="tab-text"></span>
                        <span class="favorites-count" id="favoritesCount">0</span>
                    </button>
                </div>
                
                <div id="channelSelector">
                    <div id="channelCategories">
                        <!-- 频道分类将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button
        id="fullscreenButton"
        class="fullscreen-button"
        type="button"
        aria-label="进入全屏"
        aria-pressed="false"
        data-icon-full="img/svg/fullscreen.svg"
        data-icon-compact="img/svg/fullscreen-exit.svg"
        data-label-enter="进入全屏"
        data-label-exit="退出全屏">
        <img width="24" height="24" src="img/svg/fullscreen.svg" alt="" aria-hidden="true">
    </button>

    <!-- 设置浮动层 -->
    
    <!-- 频道列表折叠/展开按钮（保留为注释，后续如需启用可改为 HTML 注释） -->
    <!--
    <div id="toggleChannelList" class="toggle-channel-list">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
        </svg>
    </div>
    -->
   
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script src="scripts/main.js?v=202510192259"></script>
    
    <!-- 设置面板 - 移动到 body 层级 -->
    <div id="settingsPanel" class="settings-panel">
        <button id="closeSettings" class="close-btn" aria-label="关闭设置">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <div class="settings-content">
            <div class="settings-section">
                <h4 data-i18n="theme_settings">主题设置</h4>
                <div class="setting-item">
                    <label for="darkMode">
                        <input type="checkbox" id="darkMode" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="dark_mode">深色模式</span>
                            <span class="setting-desc" data-i18n="dark_mode_desc">使用深色主题界面</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="interface_settings">界面设置</h4>
                <div class="setting-item">
                    <label for="languageSelect" class="language-setting">
                        <!-- 言語選択は削除し、日本語固定 -->
                        <div class="setting-info">
                            <span class="setting-title">言語</span>
                            <span class="setting-desc">日本語のみ</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="footerVisibility">
                        <input type="checkbox" id="footerVisibility">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title">下部情報バーを表示</span>
                            <span class="setting-desc">ページ下部の動画情報の表示を制御</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="defaultFullscreen">
                        <input type="checkbox" id="defaultFullscreen">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title">デフォルトでフルスクリーンモード</span>
                            <span class="setting-desc">ページ読み込み時に自動的にフルスクリーン再生</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="playback_settings">再生設定</h4>
                <div class="setting-item">
                    <label for="autoPlay">
                        <input type="checkbox" id="autoPlay" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="auto_play">自動再生</span>
                            <span class="setting-desc" data-i18n="auto_play_desc">チャンネル選択後に自動的に動画再生を開始</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="autoNext">
                        <input type="checkbox" id="autoNext">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="auto_next">自動的に次へ</span>
                            <span class="setting-desc" data-i18n="auto_next_desc">現在の動画終了後に自動的に次を再生</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="loopPlayback">
                        <input type="checkbox" id="loopPlayback">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="loop_playback">ループ再生</span>
                            <span class="setting-desc" data-i18n="loop_playback_desc">プレイリスト終了後に最初から再開</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="compactMode">
                        <input type="checkbox" id="compactMode">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="compact_mode">コンパクトモード</span>
                            <span class="setting-desc" data-i18n="compact_mode_desc">インターフェースの間隔を減らし、より多くのコンテンツを表示</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="advanced_settings">詳細設定</h4>
                <div class="setting-item">
                    <label for="debugMode">
                        <input type="checkbox" id="debugMode">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="debug_mode">デバッグモード</span>
                            <span class="setting-desc" data-i18n="debug_mode_desc">詳細なデバッグ情報を表示</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="cacheVideos">
                        <input type="checkbox" id="cacheVideos" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="cache_videos">動画をキャッシュ</span>
                            <span class="setting-desc" data-i18n="cache_videos_desc">チャンネル動画リストをキャッシュして読み込み速度を向上</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item setting-action">
                    <button id="clearCacheBtn" class="clear-cache-btn" onclick="clearAllCache()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="clear_cache">キャッシュをクリア</span>
                            <span class="setting-desc" data-i18n="clear_cache_desc">すべてのローカルキャッシュデータをクリア（お気に入り、設定など）</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- 开发者信息 -->
            <div class="settings-footer">
                <div class="footer-inner">
                    <span class="footer-copy">©</span>
                    <a href="https://iamcheyan.com/" target="_blank" rel="noreferrer noopener" class="footer-brand" title="iamcheyan.com">Cheyan</a>
                    <span class="footer-copy">All Rights Reserved</span>
                    <span class="footer-sep">•</span>
                    <a href="https://github.com/iamcheyan/terebi" target="_blank" rel="noreferrer noopener" class="footer-link" aria-label="GitHub" title="GitHub">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" fill="currentColor"><path d="M12 .5a11.5 11.5 0 0 0-3.64 22.42c.58.11.8-.25.8-.56v-2.02c-3.26.71-3.95-1.4-3.95-1.4-.53-1.36-1.3-1.72-1.3-1.72-1.06-.72.08-.71.08-.71 1.18.08 1.8 1.21 1.8 1.21 1.04 1.79 2.73 1.27 3.4.97.11-.76.41-1.27.75-1.56-2.6-.3-5.33-1.3-5.33-5.8 0-1.28.46-2.32 1.21-3.14-.12-.3-.52-1.52.11-3.17 0 0 .98-.31 3.2 1.2.94-.26 1.95-.39 2.95-.39s2.01.13 2.95.39c2.22-1.51 3.19-1.2 3.19-1.2.64 1.65.24 2.87.12 3.17.76.82 1.21 1.86 1.21 3.14 0 4.51-2.73 5.5-5.34 5.79.42.36.8 1.08.8 2.18v3.23c0 .31.21.68.81.56A11.5 11.5 0 0 0 12 .5Z"></path></svg>
                        <span class="footer-link-label">GitHub</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

<!-- 设置面板遮罩层 -->
<div id="settingsOverlay" class="settings-overlay"></div>

<!-- 频道统计面板 -->
<div id="channelStatsPanel" class="channel-stats-panel" aria-hidden="true">
    <button id="closeChannelStats" class="close-btn" aria-label="关闭频道统计">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="channel-stats-content">
        <div class="stats-header">
            <div class="header-with-chart">
                <div class="region-chart-wrapper">
                    <canvas id="regionPieChart" aria-label="地域別チャンネル比率" role="img"></canvas>
                    <div class="chart-center-label">
                        <div class="chart-total-number" id="chartTotalChannels">0</div>
                        <div class="chart-total-text" data-i18n="chart_total_channels">チャンネル</div>
                    </div>
                </div>
                <div class="header-text-content">
                    <h3 data-i18n="channel_statistics">频道统计</h3>
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-number" id="totalChannels">0</span>
                            <span class="stat-label" data-i18n="total_channels">总频道数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="totalVideos">0</span>
                            <span class="stat-label" data-i18n="total_videos">总节目数</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="site-introduction">
            <p class="intro-text">
                日本全国の約<strong>150局</strong>のテレビ局公式YouTubeチャンネルを収録。
                <strong>YouTube Data API</strong>を通じて各局がアップロードした番組情報を整理し、視聴しやすい形で提供しています。
            </p>
            <p class="intro-highlight">
                ⚠️ 当サイトはコンテンツの配信や再配布は行っておりません。<br>
                各テレビ局がYouTubeに公式アップロードした番組のみを、APIを介して整理・表示しています。<br>
                視聴できるのはテレビの生放送ではなく、各局のYouTube公式チャンネルの番組です。
            </p>
        </div>
        
        <div class="stats-regions">
            <h4 data-i18n="by_region">按地区分类</h4>
            <div id="regionStats" class="region-list">
                <!-- 地区统计将在这里显示 -->
            </div>
        </div>
    </div>
</div>

<!-- 频道统计面板遮罩层 -->
<div id="channelStatsOverlay" class="channel-stats-overlay"></div>

<!-- 观看历史面板 -->
<div id="viewHistoryPanel" class="view-history-panel">
    <button id="closeViewHistory" class="close-btn" aria-label="視聴履歴を閉じる">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="view-history-content">
        <div class="history-header">
            <h3 data-i18n="view_history">視聴履歴</h3>
            <div class="history-actions">
                <button id="clearHistoryBtn" class="clear-history-btn" title="履歴をクリア">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                    <span data-i18n="clear_history_btn">履歴をクリア</span>
                </button>
            </div>
        </div>
        
        <div class="history-stats">
            <span data-i18n="history_count_label">総記録数：</span>
            <span id="historyCount">0</span>
        </div>
        
        <!-- 全部/收藏切换标签 -->
        <div class="history-filter-tabs">
            <button class="history-filter-tab active" data-filter="all" onclick="switchHistoryFilter('all')">
                <span class="tab-text" data-i18n="history_all">すべて</span>
            </button>
            <button class="history-filter-tab" data-filter="favorites" onclick="switchHistoryFilter('favorites')">
                <span class="tab-icon">⭐</span>
                <span class="tab-text" data-i18n="history_favorites">お気に入り</span>
                <span class="favorites-count" id="historyFavoritesCount">0</span>
            </button>
        </div>
        
        <div id="historyList" class="history-list">
            <!-- 历史记录将在这里显示 -->
        </div>
    </div>
</div>

<!-- 观看历史面板遮罩层 -->
<div id="viewHistoryOverlay" class="view-history-overlay" role="presentation"></div>

<!-- 电视节目搜索面板 -->
<div id="tvSearchPanel" class="tv-search-panel">
    <button id="closeTvSearch" class="close-btn" aria-label="テレビ番組検索を閉じる">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="tv-search-content">
        <div class="search-header">
            <h3>テレビ番組検索</h3>
        </div>
        <div class="search-input-container">
            <input type="text" id="tvSearchInput" placeholder="番組名で検索（例：ちいかわ）" autocomplete="off">
            <button id="tvSearchSubmit" class="search-submit-btn" aria-label="検索">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </button>
        </div>
        <div id="tvSearchResults" class="search-results">
            <!-- 搜索结果将在这里显示 -->
        </div>
    </div>
</div>

<!-- 电视节目搜索面板遮罩层 -->
<div id="tvSearchOverlay" class="tv-search-overlay" role="presentation"></div>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC20d0C0Wj7pXRYPHlbDNXT3UK1PRat14Y",
    authDomain: "terebi-711fb.firebaseapp.com",
    projectId: "terebi-711fb",
    storageBucket: "terebi-711fb.firebasestorage.app",
    messagingSenderId: "54498356451",
    appId: "1:54498356451:web:60878e9e21dda4c95669d6",
    measurementId: "G-PMSGH0ZQN3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();
  
  // 强制显示账户选择界面，支持多账户切换
  provider.setCustomParameters({
    prompt: 'select_account'
  });

  // Make auth and db available globally
  window.firebaseAuth = auth;
  window.firebaseDb = db;

  // UI Elements
  const loginButton = document.getElementById('loginButton');
  const userProfile = document.getElementById('userProfile');
  const userAvatar = document.getElementById('userAvatar');
  const userAvatarMenu = document.getElementById('userAvatarMenu');
  const userNameMenu = document.getElementById('userNameMenu');
  const userEmailMenu = document.getElementById('userEmailMenu');
  const userMenu = document.getElementById('userMenu');
  const logoutButton = document.getElementById('logoutButton');
  const syncDataButton = document.getElementById('syncDataButton');
  const switchAccountButton = document.getElementById('switchAccountButton');

  // Show initial UI
  loginButton.style.display = 'block';

  // Toggle user menu by clicking avatar
  userAvatar?.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenu.classList.toggle('show');
  });

  // Close menu when clicking outside
  document.addEventListener('click', () => {
    userMenu?.classList.remove('show');
  });

  // Prevent menu from closing when clicking inside
  userMenu?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Login with Google
  loginButton?.addEventListener('click', async () => {
    try {
      // 清除数据加载标记
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      console.log('User signed in:', user.displayName);
      
      // Show success message
      if (window.showNotification) {
        window.showNotification(getI18nText('login_success'), 'success');
      }
      
      // onAuthStateChanged 会自动触发数据加载和同步
    } catch (error) {
      console.error('Login error:', error);
      if (window.showNotification) {
        window.showNotification(getI18nText('login_error') + ': ' + error.message, 'error');
      }
    }
  });

  // Logout
  logoutButton?.addEventListener('click', async () => {
    try {
      await signOut(auth);
      console.log('User signed out');
      
      if (window.showNotification) {
        window.showNotification(getI18nText('logout_success'), 'success');
      }
    } catch (error) {
      console.error('Logout error:', error);
      if (window.showNotification) {
        window.showNotification(getI18nText('logout_error') + ': ' + error.message, 'error');
      }
    }
  });

  // Switch account button
  switchAccountButton?.addEventListener('click', async () => {
    try {
      // 清除数据加载标记，确保新账户能加载数据
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      // 先登出当前账户
      await signOut(auth);
      console.log('User signed out for account switch');
      
      // 立即重新登录，会显示账户选择界面
      setTimeout(async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          console.log('Switched to account:', user.displayName);
          
          if (window.showNotification) {
            window.showNotification(getI18nText('switch_success'), 'success');
          }
          
          // onAuthStateChanged 会自动触发加载数据
        } catch (error) {
          console.error('Switch account error:', error);
          if (window.showNotification) {
            window.showNotification(getI18nText('switch_error') + ': ' + error.message, 'error');
          }
        }
      }, 100);
    } catch (error) {
      console.error('Logout error during switch:', error);
    }
  });

  // Sync data button - 双向同步
  syncDataButton?.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (user) {
      try {
        console.log('🔄 开始双向同步...');
        
        // 1. 先从云端加载最新数据并合并到本地（不刷新页面，静默通知）
        await loadUserData(user, { skipReload: true, silent: true });
        
        // 2. 然后将合并后的数据上传到云端
        await syncUserData(user);
        
        if (window.showNotification) {
          const lang = localStorage.getItem('language') || 'ja';
          const messages = {
            ja: 'データを同期しました',
            en: 'Data synced successfully',
            zh: '数据同步成功'
          };
          window.showNotification(messages[lang], 'success');
        }
        
        // 刷新所有数据显示
        setTimeout(() => {
          // 刷新历史记录面板
          if (window.displayViewHistory) {
            window.displayViewHistory();
          }
          
          // 更新视频收藏数量
          if (window.updateHistoryFavoritesCount) {
            window.updateHistoryFavoritesCount();
          }
          
          // 更新频道收藏数量
          if (window.updateFavoritesCount) {
            window.updateFavoritesCount();
          }
          
          // 刷新频道列表显示
          if (window.switchChannelFilter) {
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab && activeTab.getAttribute('data-filter') === 'favorites') {
              window.switchChannelFilter('favorites');
            }
          }
        }, 300);
        
        console.log('✅ 双向同步完成');
      } catch (error) {
        console.error('Sync error:', error);
        if (window.showNotification) {
          window.showNotification(getI18nText('sync_error') + ': ' + error.message, 'error');
        }
      }
    }
  });

  // Sync user data to Firestore
  async function syncUserData(user) {
    if (!user) return;

    try {
      const userRef = doc(db, 'users', user.uid);
      
      // 收集所有本地数据
      const localData = {
        // 视频收藏
        favoriteVideos: JSON.parse(localStorage.getItem('favoriteVideos') || '[]'),
        
        // 观看历史
        viewHistory: JSON.parse(localStorage.getItem('viewHistory') || '[]'),
        
        // 频道收藏
        favoriteChannels: JSON.parse(localStorage.getItem('favoriteChannels') || '[]'),
        
        // 最后观看的频道
        lastWatchedChannel: localStorage.getItem('lastWatchedChannel') 
          ? JSON.parse(localStorage.getItem('lastWatchedChannel')) 
          : null,
        
        // 用户设置
        settings: {
          language: localStorage.getItem('language') || 'ja',
          theme: localStorage.getItem('theme') || 'dark',
          footerVisibility: localStorage.getItem('footerVisibility') !== 'false',
          defaultFullscreen: localStorage.getItem('defaultFullscreen') === 'true',
          isFullscreen: localStorage.getItem('isFullscreen') === 'true'
        },
        
        // 同步时间戳
        lastSync: new Date().toISOString(),
        
        // 用户信息
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL
      };

      // 上传到 Firestore（使用 merge 来避免覆盖其他字段）
      await setDoc(userRef, localData, { merge: true });

      console.log('✅ 所有数据已同步到云端:', {
        视频收藏数: localData.favoriteVideos.length,
        观看历史数: localData.viewHistory.length,
        频道收藏数: localData.favoriteChannels.length
      });
    } catch (error) {
      console.error('❌ 同步数据失败:', error);
      throw error;
    }
  }

  // 智能合并数组数据（去重，保留最新）
  function mergeArrayData(localArray, cloudArray, keyField = 'videoId') {
    const merged = [...cloudArray];
    const existingKeys = new Set(cloudArray.map(item => item[keyField]));
    
    // 添加本地独有的项
    for (const item of localArray) {
      if (!existingKeys.has(item[keyField])) {
        merged.push(item);
      }
    }
    
    // 按时间戳排序（如果有）
    if (merged.length > 0 && merged[0].timestamp) {
      merged.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }
    
    return merged;
  }

  // Load user data from Firestore with smart merging
  async function loadUserData(user, options = {}) {
    if (!user) return;
    
    const { skipReload = false, silent = false } = options;

    try {
      const userRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userRef);

      if (userDoc.exists()) {
        const cloudData = userDoc.data();
        console.log('📥 正在从云端加载数据...');
        
        // === 1. 合并视频收藏（去重） ===
        if (cloudData.favoriteVideos) {
          const localFavorites = JSON.parse(localStorage.getItem('favoriteVideos') || '[]');
          const mergedFavorites = mergeArrayData(localFavorites, cloudData.favoriteVideos, 'videoId');
          localStorage.setItem('favoriteVideos', JSON.stringify(mergedFavorites));
          console.log('✅ 视频收藏已合并:', mergedFavorites.length, '个');
        }
        
        // === 2. 合并观看历史（去重，保留最新100条） ===
        if (cloudData.viewHistory) {
          const localHistory = JSON.parse(localStorage.getItem('viewHistory') || '[]');
          const mergedHistory = mergeArrayData(localHistory, cloudData.viewHistory, 'videoId');
          // 限制最大数量
          const limitedHistory = mergedHistory.slice(0, 100);
          localStorage.setItem('viewHistory', JSON.stringify(limitedHistory));
          console.log('✅ 观看历史已合并:', limitedHistory.length, '个');
        }
        
        // === 3. 合并频道收藏（去重） ===
        if (cloudData.favoriteChannels) {
          const localChannels = JSON.parse(localStorage.getItem('favoriteChannels') || '[]');
          const mergedChannels = [...new Set([...cloudData.favoriteChannels, ...localChannels])];
          localStorage.setItem('favoriteChannels', JSON.stringify(mergedChannels));
          console.log('✅ 频道收藏已合并:', mergedChannels.length, '个');
        }
        
        // === 4. 最后观看的频道（使用云端最新的） ===
        if (cloudData.lastWatchedChannel) {
          localStorage.setItem('lastWatchedChannel', JSON.stringify(cloudData.lastWatchedChannel));
          console.log('✅ 最后观看频道已更新');
        }
        
        // === 5. 用户设置（优先使用云端设置） ===
        if (cloudData.settings) {
          const settings = cloudData.settings;
          
          if (settings.language) {
            localStorage.setItem('language', settings.language);
          }
          if (settings.theme) {
            localStorage.setItem('theme', settings.theme);
          }
          if (settings.footerVisibility !== undefined) {
            localStorage.setItem('footerVisibility', settings.footerVisibility.toString());
          }
          if (settings.defaultFullscreen !== undefined) {
            localStorage.setItem('defaultFullscreen', settings.defaultFullscreen.toString());
          }
          if (settings.isFullscreen !== undefined) {
            localStorage.setItem('isFullscreen', settings.isFullscreen.toString());
          }
          
          console.log('✅ 用户设置已更新');
        }

        console.log('🎉 所有数据加载完成！');
        
        // 标记数据已加载，避免重复加载
        sessionStorage.setItem('dataLoaded', 'true');
        
        // 延迟一下确保 DOM 和所有脚本都已加载完成
        setTimeout(() => {
          // 触发 UI 更新
          if (window.updateFavoriteButtonState) {
            window.updateFavoriteButtonState();
          }
          
          // 刷新历史记录显示
          if (window.displayViewHistory) {
            window.displayViewHistory();
          }
          
          // 更新视频收藏数量
          if (window.updateHistoryFavoritesCount) {
            window.updateHistoryFavoritesCount();
          }
          
          // 更新频道收藏数量
          if (window.updateFavoritesCount) {
            window.updateFavoritesCount();
          }
          
          // 刷新频道列表显示（如果当前在收藏视图）
          if (window.switchChannelFilter) {
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab && activeTab.getAttribute('data-filter') === 'favorites') {
              window.switchChannelFilter('favorites');
            }
          }
          
          // 显示同步成功通知
          if (!silent && window.showNotification) {
            const lang = localStorage.getItem('language') || 'ja';
            const historyCount = cloudData.viewHistory?.length || 0;
            const channelCount = cloudData.favoriteChannels?.length || 0;
            const messages = {
              ja: `データを読み込みました (動画: ${historyCount}件, チャンネル: ${channelCount}件)`,
              en: `Data loaded (Videos: ${historyCount}, Channels: ${channelCount})`,
              zh: `数据已加载 (视频: ${historyCount}条, 频道: ${channelCount}个)`
            };
            window.showNotification(messages[lang], 'success');
          }
        }, 500);
        
        // 如果语言或主题改变了，需要刷新页面（只刷新一次）
        if (!skipReload) {
          const needsReload = sessionStorage.getItem('needsReload');
          if (needsReload === 'true') {
            sessionStorage.removeItem('needsReload');
            sessionStorage.removeItem('dataLoaded'); // 清除加载标记，以便下次登录时重新加载
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        }
        
      } else {
        // 首次登录，上传本地数据到云端
        console.log('📤 首次登录，正在上传本地数据...');
        await syncUserData(user);
        sessionStorage.setItem('dataLoaded', 'true');
      }
    } catch (error) {
      console.error('❌ 加载数据失败:', error);
    }
  }

  // Auth state observer
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // User is signed in
      console.log('User is signed in:', user.displayName);
      
      // Update UI
      loginButton.style.display = 'none';
      userProfile.style.display = 'flex';
      userAvatar.src = user.photoURL || 'img/default-avatar.png';
      userAvatarMenu.src = user.photoURL || 'img/default-avatar.png';
      userNameMenu.textContent = user.displayName || 'User';
      userEmailMenu.textContent = user.email || '';

      // 检查是否已经加载过数据（防止重复加载）
      const dataLoaded = sessionStorage.getItem('dataLoaded');
      if (dataLoaded !== 'true') {
        // Load user data from cloud
        await loadUserData(user);
      } else {
        console.log('数据已加载，跳过重复加载');
      }
    } else {
      // User is signed out
      console.log('User is signed out');
      
      // 清除数据加载标记
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      // Update UI
      loginButton.style.display = 'block';
      userProfile.style.display = 'none';
      userMenu?.classList.remove('show');
    }
  });

  // Make functions available globally
  window.syncUserData = syncUserData;
  window.loadUserData = loadUserData;

  // === 自动同步功能 ===
  
  let autoSyncInterval = null;
  
  // 开始自动同步
  function startAutoSync() {
    if (autoSyncInterval) {
      clearInterval(autoSyncInterval);
    }
    
    const user = auth.currentUser;
    if (!user) return;
    
    console.log('🔄 启动自动同步（每5分钟）');
    
    // 每5分钟自动同步一次
    autoSyncInterval = setInterval(async () => {
      const currentUser = auth.currentUser;
      if (currentUser) {
        try {
          console.log('⏰ 定期自动同步中...');
          await syncUserData(currentUser);
          console.log('✅ 定期同步完成');
        } catch (error) {
          console.error('❌ 定期同步失败:', error);
        }
      }
    }, 5 * 60 * 1000); // 5分钟
  }
  
  // 停止自动同步
  function stopAutoSync() {
    if (autoSyncInterval) {
      clearInterval(autoSyncInterval);
      autoSyncInterval = null;
      console.log('⏸️ 自动同步已停止');
    }
  }
  
  // 页面可见性变化时同步
  document.addEventListener('visibilitychange', async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    if (document.visibilityState === 'visible') {
      // 页面重新可见，从云端拉取最新数据
      console.log('👀 页面重新可见，检查云端数据...');
      try {
        await loadUserData(user, { skipReload: true, silent: true });
        console.log('✅ 云端数据已同步到本地');
      } catch (error) {
        console.error('❌ 同步失败:', error);
      }
    } else {
      // 页面即将隐藏，上传本地数据到云端
      console.log('📤 页面即将隐藏，上传本地数据...');
      try {
        await syncUserData(user);
        console.log('✅ 本地数据已上传到云端');
      } catch (error) {
        console.error('❌ 上传失败:', error);
      }
    }
  });
  
  // 页面即将关闭时同步
  window.addEventListener('beforeunload', async (e) => {
    const user = auth.currentUser;
    if (user) {
      try {
        console.log('🚪 页面即将关闭，保存数据...');
        await syncUserData(user);
      } catch (error) {
        console.error('❌ 关闭前同步失败:', error);
      }
    }
  });
  
  // 监听认证状态，启动或停止自动同步
  onAuthStateChanged(auth, (user) => {
    if (user) {
      startAutoSync();
    } else {
      stopAutoSync();
    }
  });

  // Helper function to get i18n text
  function getI18nText(key) {
    const lang = localStorage.getItem('selectedLanguage') || 'ja';
    const i18n = {
      ja: {
        login_success: 'ログインしました',
        login_error: 'ログインエラー',
        logout_success: 'ログアウトしました',
        logout_error: 'ログアウトエラー',
        sync_success: 'データを同期しました',
        sync_error: '同期エラー',
        switch_success: 'アカウントを切り替えました',
        switch_error: '切り替えエラー'
      },
      en: {
        login_success: 'Logged in successfully',
        login_error: 'Login error',
        logout_success: 'Logged out successfully',
        logout_error: 'Logout error',
        sync_success: 'Data synced successfully',
        sync_error: 'Sync error',
        switch_success: 'Account switched successfully',
        switch_error: 'Switch error'
      },
      zh: {
        login_success: '登录成功',
        login_error: '登录错误',
        logout_success: '登出成功',
        logout_error: '登出错误',
        sync_success: '数据同步成功',
        sync_error: '同步错误',
        switch_success: '账户切换成功',
        switch_error: '切换错误'
      }
    };
    return i18n[lang]?.[key] || i18n['ja'][key];
  }
</script>

<!-- 添加跨域错误修复脚本 -->
<script src="fix_cross_origin_error.js?v=202510192259"></script>

</body>
</html>
