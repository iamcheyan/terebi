<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Terebi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- æ·»åŠ  favicon -->
    <link rel="icon" href="static/logo.png" type="image/png">
    <script>
        (function() {
            var storageKey = 'preferredTheme';
            var theme = 'dark';
            try {
                var storedTheme = localStorage.getItem(storageKey);
                if (storedTheme === 'light' || storedTheme === 'dark') {
                    theme = storedTheme;
                } else if (window.matchMedia) {
                    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
            } catch (error) {
                console.warn('æ— æ³•ä»æœ¬åœ°å­˜å‚¨è¯»å–ä¸»é¢˜åå¥½:', error);
            }

            var root = document.documentElement;
            root.dataset.theme = theme;
            root.classList.add('theme-' + theme);
            root.style.colorScheme = theme;
        })();
    </script>

    <!-- åŸºç¡€æ ·å¼ - æ‰€æœ‰è®¾å¤‡éƒ½åŠ è½½ -->
    <link rel="stylesheet" href="styles/main.css">
    
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="fixed-box">
                <div class="page-header">
    <div class="logo-box">
        <!-- LOGO -->
        <img class="logo" src="static/logo.png" alt="logo">
        <h1>ãƒ†ãƒ¬ãƒ“</h1>
    </div>
        <div class="link-box">
        <!-- ç”¨æˆ·è´¦æˆ· -->
        <div class="user-account">
            <button id="loginButton" class="login-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span class="login-text" data-i18n="login">ãƒ­ã‚°ã‚¤ãƒ³</span>
            </button>
            <div id="userProfile" class="user-profile" style="display: none;">
                <img id="userAvatar" class="user-avatar" src="" alt="User" style="cursor: pointer;">
                <div id="userMenu" class="user-menu">
                    <div class="user-menu-header">
                        <img id="userAvatarMenu" class="user-avatar-large" src="" alt="User">
                        <div class="user-info">
                            <div id="userNameMenu" class="user-name"></div>
                            <div id="userEmailMenu" class="user-email"></div>
                        </div>
                    </div>
                    <div class="user-menu-divider"></div>
                    <button id="syncDataButton" class="user-menu-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        <span data-i18n="sync_data">åŒæ­¥æ•°æ®</span>
                    </button>
                    <button id="switchAccountButton" class="user-menu-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span data-i18n="switch_account">åˆ‡æ¢è´¦æˆ·</span>
                    </button>
                    <button id="logoutButton" class="user-menu-item logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span data-i18n="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- <div class="cheyan">
            <a href="https://iamcheyan.com" target="_blank">
                <img src="img/svg/cheyan.jpg" alt="cheyan" width="32" height="32">
            </a>
        </div>
        <div class="git">
            <a class="icon-button" href="https://github.com/iamcheyan/terebi/" target="_blank" title="GitLabã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹" aria-label="GitLabã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹">
                <svg aria-hidden="true" role="img" class="tanuki-logo" width="32" height="32" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path class="tanuki-shape tanuki" d="m24.507 9.5-.034-.09L21.082.562a.896.896 0 0 0-1.694.091l-2.29 7.01H7.825L5.535.653a.898.898 0 0 0-1.694-.09L.451 9.411.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 2.56 1.935 1.554 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z" fill="#E24329"></path>
                    <path class="tanuki-shape right-cheek" d="m24.507 9.5-.034-.09a11.44 11.44 0 0 0-4.56 2.051l-7.447 5.632 4.742 3.584 5.197-3.89.014-.01A6.297 6.297 0 0 0 24.507 9.5Z" fill="#FC6D26"></path>
                    <path class="tanuki-shape chin" d="m7.707 20.677 2.56 1.935 1.555 1.176a1.051 1.051 0 0 0 1.268 0l1.555-1.176 2.56-1.935-4.743-3.584-4.755 3.584Z" fill="#FCA326"></path>
                    <path class="tanuki-shape left-cheek" d="M5.01 11.461a11.43 11.43 0 0 0-4.56-2.05L.416 9.5a6.297 6.297 0 0 0 2.09 7.278l.012.01.03.022 5.16 3.867 4.745-3.584-7.444-5.632Z" fill="#FC6D26"></path>
                </svg>
            </a>
        </div> -->
        <div class="view-history">
            <button id="viewHistoryButton" class="icon-button" title="è§‚çœ‹å†å²" aria-label="è§‚çœ‹å†å²">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </button>
        </div>
        <div class="channel-stats">
            <button id="channelStatsButton" class="icon-button" title="é¢‘é“ç»Ÿè®¡" aria-label="é¢‘é“ç»Ÿè®¡">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"></path>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                </svg>
            </button>
        </div>
        <div class="settings">
            <button id="settingsButton" class="icon-button" title="è®¾ç½®" aria-label="è®¾ç½®">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

                <div class="left-column">
                    <div class="box-container">
                    <!-- æ’­æ”¾å™¨å®¹å™¨ -->
                        <div id="playerContainer">
                            <div class="player-loading">
                                <img class="loading-icon" width="24" height="24" src="img/svg/loading.svg" alt="loading">
                                <span>å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</span>
                            </div>
                            <div id="player"></div>
                        </div>
                        
                        <!-- æ¸…é™¤ç­›é€‰æŒ‰é’® -->
                        <button id="clearFilterButton" class="clear-filter-btn" style="display: none;" onclick="clearRegionFilter()">
                            <span class="filter-icon">âœ•</span>
                            <span class="filter-text">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</span>
                        </button>
                        
                        <!-- çŠ¶æ€ä¿¡æ¯ç§»åˆ°æ’­æ”¾å™¨ä¸‹æ–¹ -->
                        <div id="status">æº–å‚™å®Œäº†ã€ãƒãƒ£ãƒ³ãƒãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                        
                        <div id="videoContainer" class="video-grid" style="display: none;">
                            <!-- è§†é¢‘å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                </div>
                <!-- footer -->
                <footer class="footer">
                    <div class="footer-content">
                        <div class="channel-logo">
                            <img id="currentChannelLogo" src="img/default-logo.png" alt="é¢‘é“æ ‡å¿—">
                        </div>
                        <div class="program-info">
                            <div class="program-title-container">
                                <a id="currentVideoTitleLink" href="#" target="_blank" class="program-title-link">
                                    <span id="currentVideoTitle" class="program-title">æœªé€‰æ‹©èŠ‚ç›®</span>
                                </a>
                                <button id="favoriteVideoBtn" class="favorite-video-btn" title="æ”¶è—èŠ‚ç›®" style="display: none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                            <div id="currentChannelName" class="channel-name" style="display: none;">æœªé€‰æ‹©é¢‘é“</div>
                            <div id="currentChannelUrl" class="channel-url">https://www.youtube.com/</div>
                        </div>
                        <div class="footer-info">
                            <div class="copyright">
                                <div class="first-line">
                                    <span>éå…¬å¼YouTubeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ„ãƒ¼ãƒ«</span>
                                    
                                </div>
                                <span>è‘—ä½œæ¨©ã¯åŸä½œè€…ã«å¸°å±ã€ä¿å­˜ãƒ»é…ä¿¡ã¯è¡Œã„ã¾ã›ã‚“</span>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
            <div class="right-column">
                <div class="channel-list-title">
                    ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆ
                </div>
                
                <!-- æ·»åŠ æœç´¢è¾“å…¥æ¡† -->
                <input type="text" id="channelSearch" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ¤œç´¢..." onkeyup="filterChannels()">
                
                <!-- å…¨éƒ¨/æ”¶è—åˆ‡æ¢æ ‡ç­¾ -->
                <div class="channel-filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="switchChannelFilter('all')">
                        <span class="tab-icon"></span>
                        <span class="tab-text">å…¨ã¦</span>
                    </button>
                    <button class="filter-tab" data-filter="favorites" onclick="switchChannelFilter('favorites')">
                        <span class="tab-icon">â­</span>
                        <span class="tab-text"></span>
                        <span class="favorites-count" id="favoritesCount">0</span>
                    </button>
                </div>
                
                <div id="channelSelector">
                    <div id="channelCategories">
                        <!-- é¢‘é“åˆ†ç±»å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button
        id="fullscreenButton"
        class="fullscreen-button"
        type="button"
        aria-label="è¿›å…¥å…¨å±"
        aria-pressed="false"
        data-icon-full="img/svg/fullscreen.svg"
        data-icon-compact="img/svg/fullscreen-exit.svg"
        data-label-enter="è¿›å…¥å…¨å±"
        data-label-exit="é€€å‡ºå…¨å±">
        <img width="24" height="24" src="img/svg/fullscreen.svg" alt="" aria-hidden="true">
    </button>

    <!-- è®¾ç½®æµ®åŠ¨å±‚ -->
    
    <!-- é¢‘é“åˆ—è¡¨æŠ˜å /å±•å¼€æŒ‰é’®ï¼ˆä¿ç•™ä¸ºæ³¨é‡Šï¼Œåç»­å¦‚éœ€å¯ç”¨å¯æ”¹ä¸º HTML æ³¨é‡Šï¼‰ -->
    <!--
    <div id="toggleChannelList" class="toggle-channel-list">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
        </svg>
    </div>
    -->
   
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script src="scripts/main.js"></script>
    
    <!-- è®¾ç½®é¢æ¿ - ç§»åŠ¨åˆ° body å±‚çº§ -->
    <div id="settingsPanel" class="settings-panel">
        <button id="closeSettings" class="close-btn" aria-label="å…³é—­è®¾ç½®">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <div class="settings-content">
            <div class="settings-section">
                <h4 data-i18n="theme_settings">ä¸»é¢˜è®¾ç½®</h4>
                <div class="setting-item">
                    <label for="darkMode">
                        <input type="checkbox" id="darkMode" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="dark_mode">æ·±è‰²æ¨¡å¼</span>
                            <span class="setting-desc" data-i18n="dark_mode_desc">ä½¿ç”¨æ·±è‰²ä¸»é¢˜ç•Œé¢</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="interface_settings">ç•Œé¢è®¾ç½®</h4>
                <div class="setting-item">
                    <label for="languageSelect" class="language-setting">
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="language">è¯­è¨€</span>
                            <span class="setting-desc" data-i18n="language_desc">é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€</span>
                        </div>
                        <select id="languageSelect" class="language-select">
                            <option value="ja" data-i18n="japanese">æ—¥æœ¬èª</option>
                            <option value="en" data-i18n="english">English</option>
                            <option value="zh" data-i18n="chinese">ä¸­æ–‡</option>
                        </select>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="footerVisibility">
                        <input type="checkbox" id="footerVisibility">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="show_footer">æ˜¾ç¤ºåº•éƒ¨ä¿¡æ¯æ </span>
                            <span class="setting-desc" data-i18n="show_footer_desc">æ§åˆ¶é¡µé¢åº•éƒ¨è§†é¢‘ä¿¡æ¯çš„æ˜¾ç¤º</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="defaultFullscreen">
                        <input type="checkbox" id="defaultFullscreen">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="default_fullscreen">é»˜è®¤è¿›å…¥å…¨å±æ¨¡å¼</span>
                            <span class="setting-desc" data-i18n="default_fullscreen_desc">é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿›å…¥å…¨å±æ’­æ”¾</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="playback_settings">æ’­æ”¾è®¾ç½®</h4>
                <div class="setting-item">
                    <label for="autoPlay">
                        <input type="checkbox" id="autoPlay" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="auto_play">è‡ªåŠ¨æ’­æ”¾</span>
                            <span class="setting-desc" data-i18n="auto_play_desc">é€‰æ‹©é¢‘é“åè‡ªåŠ¨å¼€å§‹æ’­æ”¾è§†é¢‘</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="autoNext">
                        <input type="checkbox" id="autoNext">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="auto_next">è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª</span>
                            <span class="setting-desc" data-i18n="auto_next_desc">å½“å‰è§†é¢‘ç»“æŸåè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ª</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="loopPlayback">
                        <input type="checkbox" id="loopPlayback">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="loop_playback">å¾ªç¯æ’­æ”¾</span>
                            <span class="setting-desc" data-i18n="loop_playback_desc">æ’­æ”¾åˆ—è¡¨ç»“æŸåé‡æ–°å¼€å§‹</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="compactMode">
                        <input type="checkbox" id="compactMode">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="compact_mode">ç´§å‡‘æ¨¡å¼</span>
                            <span class="setting-desc" data-i18n="compact_mode_desc">å‡å°‘ç•Œé¢é—´è·ï¼Œæ˜¾ç¤ºæ›´å¤šå†…å®¹</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h4 data-i18n="advanced_settings">é«˜çº§è®¾ç½®</h4>
                <div class="setting-item">
                    <label for="debugMode">
                        <input type="checkbox" id="debugMode">
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="debug_mode">è°ƒè¯•æ¨¡å¼</span>
                            <span class="setting-desc" data-i18n="debug_mode_desc">æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item">
                    <label for="cacheVideos">
                        <input type="checkbox" id="cacheVideos" checked>
                        <span class="checkmark"></span>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="cache_videos">ç¼“å­˜è§†é¢‘ä¿¡æ¯</span>
                            <span class="setting-desc" data-i18n="cache_videos_desc">ç¼“å­˜é¢‘é“è§†é¢‘åˆ—è¡¨ä»¥æé«˜åŠ è½½é€Ÿåº¦</span>
                        </div>
                    </label>
                </div>
                <div class="setting-item setting-action">
                    <button id="clearCacheBtn" class="clear-cache-btn" onclick="clearAllCache()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        <div class="setting-info">
                            <span class="setting-title" data-i18n="clear_cache">æ¸…é™¤ç¼“å­˜</span>
                            <span class="setting-desc" data-i18n="clear_cache_desc">æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜æ•°æ®ï¼ˆåŒ…æ‹¬æ”¶è—ã€è®¾ç½®ç­‰ï¼‰</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- è®¾ç½®é¢æ¿é®ç½©å±‚ -->
<div id="settingsOverlay" class="settings-overlay"></div>

<!-- é¢‘é“ç»Ÿè®¡é¢æ¿ -->
<div id="channelStatsPanel" class="channel-stats-panel" aria-hidden="true">
    <button id="closeChannelStats" class="close-btn" aria-label="å…³é—­é¢‘é“ç»Ÿè®¡">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="channel-stats-content">
        <div class="stats-header">
            <div class="header-with-chart">
                <div class="region-chart-wrapper">
                    <canvas id="regionPieChart" aria-label="åœ°åŸŸåˆ¥ãƒãƒ£ãƒ³ãƒãƒ«æ¯”ç‡" role="img"></canvas>
                    <div class="chart-center-label">
                        <div class="chart-total-number" id="chartTotalChannels">0</div>
                        <div class="chart-total-text" data-i18n="chart_total_channels">ãƒãƒ£ãƒ³ãƒãƒ«</div>
                    </div>
                </div>
                <div class="header-text-content">
                    <h3 data-i18n="channel_statistics">é¢‘é“ç»Ÿè®¡</h3>
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-number" id="totalChannels">0</span>
                            <span class="stat-label" data-i18n="total_channels">æ€»é¢‘é“æ•°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="totalVideos">0</span>
                            <span class="stat-label" data-i18n="total_videos">æ€»èŠ‚ç›®æ•°</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="site-introduction">
            <p class="intro-text">
                æ—¥æœ¬å…¨å›½ã®ç´„<strong>150å±€</strong>ã®ãƒ†ãƒ¬ãƒ“å±€å…¬å¼YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã‚’åéŒ²ã€‚
                <strong>YouTube Data API</strong>ã‚’é€šã˜ã¦å„å±€ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç•ªçµ„æƒ…å ±ã‚’æ•´ç†ã—ã€è¦–è´ã—ã‚„ã™ã„å½¢ã§æä¾›ã—ã¦ã„ã¾ã™ã€‚
            </p>
            <p class="intro-highlight">
                âš ï¸ å½“ã‚µã‚¤ãƒˆã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é…ä¿¡ã‚„å†é…å¸ƒã¯è¡Œã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚<br>
                å„ãƒ†ãƒ¬ãƒ“å±€ãŒYouTubeã«å…¬å¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç•ªçµ„ã®ã¿ã‚’ã€APIã‚’ä»‹ã—ã¦æ•´ç†ãƒ»è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
                è¦–è´ã§ãã‚‹ã®ã¯ãƒ†ãƒ¬ãƒ“ã®ç”Ÿæ”¾é€ã§ã¯ãªãã€å„å±€ã®YouTubeå…¬å¼ãƒãƒ£ãƒ³ãƒãƒ«ã®ç•ªçµ„ã§ã™ã€‚
            </p>
        </div>
        
        <div class="stats-regions">
            <h4 data-i18n="by_region">æŒ‰åœ°åŒºåˆ†ç±»</h4>
            <div id="regionStats" class="region-list">
                <!-- åœ°åŒºç»Ÿè®¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>
</div>

<!-- é¢‘é“ç»Ÿè®¡é¢æ¿é®ç½©å±‚ -->
<div id="channelStatsOverlay" class="channel-stats-overlay"></div>

<!-- è§‚çœ‹å†å²é¢æ¿ -->
<div id="viewHistoryPanel" class="view-history-panel">
    <button id="closeViewHistory" class="close-btn" aria-label="å…³é—­è§‚çœ‹å†å²">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <div class="view-history-content">
        <div class="history-header">
            <h3 data-i18n="view_history">è§‚çœ‹å†å²</h3>
            <div class="history-actions">
                <button id="clearHistoryBtn" class="clear-history-btn" title="æ¸…ç©ºå†å²è®°å½•">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                    <span data-i18n="clear_history_btn">æ¸…ç©ºå†å²</span>
                </button>
            </div>
        </div>
        
        <div class="history-stats">
            <span data-i18n="history_count_label">æ€»è®°å½•æ•°ï¼š</span>
            <span id="historyCount">0</span>
        </div>
        
        <!-- å…¨éƒ¨/æ”¶è—åˆ‡æ¢æ ‡ç­¾ -->
        <div class="history-filter-tabs">
            <button class="history-filter-tab active" data-filter="all" onclick="switchHistoryFilter('all')">
                <span class="tab-text" data-i18n="history_all">å…¨éƒ¨</span>
            </button>
            <button class="history-filter-tab" data-filter="favorites" onclick="switchHistoryFilter('favorites')">
                <span class="tab-icon">â­</span>
                <span class="tab-text" data-i18n="history_favorites">æ”¶è—</span>
                <span class="favorites-count" id="historyFavoritesCount">0</span>
            </button>
        </div>
        
        <div id="historyList" class="history-list">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
</div>

<!-- è§‚çœ‹å†å²é¢æ¿é®ç½©å±‚ -->
<div id="viewHistoryOverlay" class="view-history-overlay" role="presentation"></div>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC20d0C0Wj7pXRYPHlbDNXT3UK1PRat14Y",
    authDomain: "terebi-711fb.firebaseapp.com",
    projectId: "terebi-711fb",
    storageBucket: "terebi-711fb.firebasestorage.app",
    messagingSenderId: "54498356451",
    appId: "1:54498356451:web:60878e9e21dda4c95669d6",
    measurementId: "G-PMSGH0ZQN3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();
  
  // å¼ºåˆ¶æ˜¾ç¤ºè´¦æˆ·é€‰æ‹©ç•Œé¢ï¼Œæ”¯æŒå¤šè´¦æˆ·åˆ‡æ¢
  provider.setCustomParameters({
    prompt: 'select_account'
  });

  // Make auth and db available globally
  window.firebaseAuth = auth;
  window.firebaseDb = db;

  // UI Elements
  const loginButton = document.getElementById('loginButton');
  const userProfile = document.getElementById('userProfile');
  const userAvatar = document.getElementById('userAvatar');
  const userAvatarMenu = document.getElementById('userAvatarMenu');
  const userNameMenu = document.getElementById('userNameMenu');
  const userEmailMenu = document.getElementById('userEmailMenu');
  const userMenu = document.getElementById('userMenu');
  const logoutButton = document.getElementById('logoutButton');
  const syncDataButton = document.getElementById('syncDataButton');
  const switchAccountButton = document.getElementById('switchAccountButton');

  // Show initial UI
  loginButton.style.display = 'block';

  // Toggle user menu by clicking avatar
  userAvatar?.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenu.classList.toggle('show');
  });

  // Close menu when clicking outside
  document.addEventListener('click', () => {
    userMenu?.classList.remove('show');
  });

  // Prevent menu from closing when clicking inside
  userMenu?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Login with Google
  loginButton?.addEventListener('click', async () => {
    try {
      // æ¸…é™¤æ•°æ®åŠ è½½æ ‡è®°
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      console.log('User signed in:', user.displayName);
      
      // Show success message
      if (window.showNotification) {
        window.showNotification(getI18nText('login_success'), 'success');
      }
      
      // onAuthStateChanged ä¼šè‡ªåŠ¨è§¦å‘æ•°æ®åŠ è½½å’ŒåŒæ­¥
    } catch (error) {
      console.error('Login error:', error);
      if (window.showNotification) {
        window.showNotification(getI18nText('login_error') + ': ' + error.message, 'error');
      }
    }
  });

  // Logout
  logoutButton?.addEventListener('click', async () => {
    try {
      await signOut(auth);
      console.log('User signed out');
      
      if (window.showNotification) {
        window.showNotification(getI18nText('logout_success'), 'success');
      }
    } catch (error) {
      console.error('Logout error:', error);
      if (window.showNotification) {
        window.showNotification(getI18nText('logout_error') + ': ' + error.message, 'error');
      }
    }
  });

  // Switch account button
  switchAccountButton?.addEventListener('click', async () => {
    try {
      // æ¸…é™¤æ•°æ®åŠ è½½æ ‡è®°ï¼Œç¡®ä¿æ–°è´¦æˆ·èƒ½åŠ è½½æ•°æ®
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      // å…ˆç™»å‡ºå½“å‰è´¦æˆ·
      await signOut(auth);
      console.log('User signed out for account switch');
      
      // ç«‹å³é‡æ–°ç™»å½•ï¼Œä¼šæ˜¾ç¤ºè´¦æˆ·é€‰æ‹©ç•Œé¢
      setTimeout(async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          console.log('Switched to account:', user.displayName);
          
          if (window.showNotification) {
            window.showNotification(getI18nText('switch_success'), 'success');
          }
          
          // onAuthStateChanged ä¼šè‡ªåŠ¨è§¦å‘åŠ è½½æ•°æ®
        } catch (error) {
          console.error('Switch account error:', error);
          if (window.showNotification) {
            window.showNotification(getI18nText('switch_error') + ': ' + error.message, 'error');
          }
        }
      }, 100);
    } catch (error) {
      console.error('Logout error during switch:', error);
    }
  });

  // Sync data button - åŒå‘åŒæ­¥
  syncDataButton?.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (user) {
      try {
        console.log('ğŸ”„ å¼€å§‹åŒå‘åŒæ­¥...');
        
        // 1. å…ˆä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®å¹¶åˆå¹¶åˆ°æœ¬åœ°ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼Œé™é»˜é€šçŸ¥ï¼‰
        await loadUserData(user, { skipReload: true, silent: true });
        
        // 2. ç„¶åå°†åˆå¹¶åçš„æ•°æ®ä¸Šä¼ åˆ°äº‘ç«¯
        await syncUserData(user);
        
        if (window.showNotification) {
          const lang = localStorage.getItem('language') || 'ja';
          const messages = {
            ja: 'ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ',
            en: 'Data synced successfully',
            zh: 'æ•°æ®åŒæ­¥æˆåŠŸ'
          };
          window.showNotification(messages[lang], 'success');
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®æ˜¾ç¤º
        setTimeout(() => {
          // åˆ·æ–°å†å²è®°å½•é¢æ¿
          if (window.displayViewHistory) {
            window.displayViewHistory();
          }
          
          // æ›´æ–°è§†é¢‘æ”¶è—æ•°é‡
          if (window.updateHistoryFavoritesCount) {
            window.updateHistoryFavoritesCount();
          }
          
          // æ›´æ–°é¢‘é“æ”¶è—æ•°é‡
          if (window.updateFavoritesCount) {
            window.updateFavoritesCount();
          }
          
          // åˆ·æ–°é¢‘é“åˆ—è¡¨æ˜¾ç¤º
          if (window.switchChannelFilter) {
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab && activeTab.getAttribute('data-filter') === 'favorites') {
              window.switchChannelFilter('favorites');
            }
          }
        }, 300);
        
        console.log('âœ… åŒå‘åŒæ­¥å®Œæˆ');
      } catch (error) {
        console.error('Sync error:', error);
        if (window.showNotification) {
          window.showNotification(getI18nText('sync_error') + ': ' + error.message, 'error');
        }
      }
    }
  });

  // Sync user data to Firestore
  async function syncUserData(user) {
    if (!user) return;

    try {
      const userRef = doc(db, 'users', user.uid);
      
      // æ”¶é›†æ‰€æœ‰æœ¬åœ°æ•°æ®
      const localData = {
        // è§†é¢‘æ”¶è—
        favoriteVideos: JSON.parse(localStorage.getItem('favoriteVideos') || '[]'),
        
        // è§‚çœ‹å†å²
        viewHistory: JSON.parse(localStorage.getItem('viewHistory') || '[]'),
        
        // é¢‘é“æ”¶è—
        favoriteChannels: JSON.parse(localStorage.getItem('favoriteChannels') || '[]'),
        
        // æœ€åè§‚çœ‹çš„é¢‘é“
        lastWatchedChannel: localStorage.getItem('lastWatchedChannel') 
          ? JSON.parse(localStorage.getItem('lastWatchedChannel')) 
          : null,
        
        // ç”¨æˆ·è®¾ç½®
        settings: {
          language: localStorage.getItem('language') || 'ja',
          theme: localStorage.getItem('theme') || 'dark',
          footerVisibility: localStorage.getItem('footerVisibility') !== 'false',
          defaultFullscreen: localStorage.getItem('defaultFullscreen') === 'true',
          isFullscreen: localStorage.getItem('isFullscreen') === 'true'
        },
        
        // åŒæ­¥æ—¶é—´æˆ³
        lastSync: new Date().toISOString(),
        
        // ç”¨æˆ·ä¿¡æ¯
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL
      };

      // ä¸Šä¼ åˆ° Firestoreï¼ˆä½¿ç”¨ merge æ¥é¿å…è¦†ç›–å…¶ä»–å­—æ®µï¼‰
      await setDoc(userRef, localData, { merge: true });

      console.log('âœ… æ‰€æœ‰æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯:', {
        è§†é¢‘æ”¶è—æ•°: localData.favoriteVideos.length,
        è§‚çœ‹å†å²æ•°: localData.viewHistory.length,
        é¢‘é“æ”¶è—æ•°: localData.favoriteChannels.length
      });
    } catch (error) {
      console.error('âŒ åŒæ­¥æ•°æ®å¤±è´¥:', error);
      throw error;
    }
  }

  // æ™ºèƒ½åˆå¹¶æ•°ç»„æ•°æ®ï¼ˆå»é‡ï¼Œä¿ç•™æœ€æ–°ï¼‰
  function mergeArrayData(localArray, cloudArray, keyField = 'videoId') {
    const merged = [...cloudArray];
    const existingKeys = new Set(cloudArray.map(item => item[keyField]));
    
    // æ·»åŠ æœ¬åœ°ç‹¬æœ‰çš„é¡¹
    for (const item of localArray) {
      if (!existingKeys.has(item[keyField])) {
        merged.push(item);
      }
    }
    
    // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆå¦‚æœæœ‰ï¼‰
    if (merged.length > 0 && merged[0].timestamp) {
      merged.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }
    
    return merged;
  }

  // Load user data from Firestore with smart merging
  async function loadUserData(user, options = {}) {
    if (!user) return;
    
    const { skipReload = false, silent = false } = options;

    try {
      const userRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userRef);

      if (userDoc.exists()) {
        const cloudData = userDoc.data();
        console.log('ğŸ“¥ æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...');
        
        // === 1. åˆå¹¶è§†é¢‘æ”¶è—ï¼ˆå»é‡ï¼‰ ===
        if (cloudData.favoriteVideos) {
          const localFavorites = JSON.parse(localStorage.getItem('favoriteVideos') || '[]');
          const mergedFavorites = mergeArrayData(localFavorites, cloudData.favoriteVideos, 'videoId');
          localStorage.setItem('favoriteVideos', JSON.stringify(mergedFavorites));
          console.log('âœ… è§†é¢‘æ”¶è—å·²åˆå¹¶:', mergedFavorites.length, 'ä¸ª');
        }
        
        // === 2. åˆå¹¶è§‚çœ‹å†å²ï¼ˆå»é‡ï¼Œä¿ç•™æœ€æ–°100æ¡ï¼‰ ===
        if (cloudData.viewHistory) {
          const localHistory = JSON.parse(localStorage.getItem('viewHistory') || '[]');
          const mergedHistory = mergeArrayData(localHistory, cloudData.viewHistory, 'videoId');
          // é™åˆ¶æœ€å¤§æ•°é‡
          const limitedHistory = mergedHistory.slice(0, 100);
          localStorage.setItem('viewHistory', JSON.stringify(limitedHistory));
          console.log('âœ… è§‚çœ‹å†å²å·²åˆå¹¶:', limitedHistory.length, 'ä¸ª');
        }
        
        // === 3. åˆå¹¶é¢‘é“æ”¶è—ï¼ˆå»é‡ï¼‰ ===
        if (cloudData.favoriteChannels) {
          const localChannels = JSON.parse(localStorage.getItem('favoriteChannels') || '[]');
          const mergedChannels = [...new Set([...cloudData.favoriteChannels, ...localChannels])];
          localStorage.setItem('favoriteChannels', JSON.stringify(mergedChannels));
          console.log('âœ… é¢‘é“æ”¶è—å·²åˆå¹¶:', mergedChannels.length, 'ä¸ª');
        }
        
        // === 4. æœ€åè§‚çœ‹çš„é¢‘é“ï¼ˆä½¿ç”¨äº‘ç«¯æœ€æ–°çš„ï¼‰ ===
        if (cloudData.lastWatchedChannel) {
          localStorage.setItem('lastWatchedChannel', JSON.stringify(cloudData.lastWatchedChannel));
          console.log('âœ… æœ€åè§‚çœ‹é¢‘é“å·²æ›´æ–°');
        }
        
        // === 5. ç”¨æˆ·è®¾ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨äº‘ç«¯è®¾ç½®ï¼‰ ===
        if (cloudData.settings) {
          const settings = cloudData.settings;
          
          if (settings.language) {
            localStorage.setItem('language', settings.language);
          }
          if (settings.theme) {
            localStorage.setItem('theme', settings.theme);
          }
          if (settings.footerVisibility !== undefined) {
            localStorage.setItem('footerVisibility', settings.footerVisibility.toString());
          }
          if (settings.defaultFullscreen !== undefined) {
            localStorage.setItem('defaultFullscreen', settings.defaultFullscreen.toString());
          }
          if (settings.isFullscreen !== undefined) {
            localStorage.setItem('isFullscreen', settings.isFullscreen.toString());
          }
          
          console.log('âœ… ç”¨æˆ·è®¾ç½®å·²æ›´æ–°');
        }

        console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼');
        
        // æ ‡è®°æ•°æ®å·²åŠ è½½ï¼Œé¿å…é‡å¤åŠ è½½
        sessionStorage.setItem('dataLoaded', 'true');
        
        // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿ DOM å’Œæ‰€æœ‰è„šæœ¬éƒ½å·²åŠ è½½å®Œæˆ
        setTimeout(() => {
          // è§¦å‘ UI æ›´æ–°
          if (window.updateFavoriteButtonState) {
            window.updateFavoriteButtonState();
          }
          
          // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
          if (window.displayViewHistory) {
            window.displayViewHistory();
          }
          
          // æ›´æ–°è§†é¢‘æ”¶è—æ•°é‡
          if (window.updateHistoryFavoritesCount) {
            window.updateHistoryFavoritesCount();
          }
          
          // æ›´æ–°é¢‘é“æ”¶è—æ•°é‡
          if (window.updateFavoritesCount) {
            window.updateFavoritesCount();
          }
          
          // åˆ·æ–°é¢‘é“åˆ—è¡¨æ˜¾ç¤ºï¼ˆå¦‚æœå½“å‰åœ¨æ”¶è—è§†å›¾ï¼‰
          if (window.switchChannelFilter) {
            const activeTab = document.querySelector('.filter-tab.active');
            if (activeTab && activeTab.getAttribute('data-filter') === 'favorites') {
              window.switchChannelFilter('favorites');
            }
          }
          
          // æ˜¾ç¤ºåŒæ­¥æˆåŠŸé€šçŸ¥
          if (!silent && window.showNotification) {
            const lang = localStorage.getItem('language') || 'ja';
            const historyCount = cloudData.viewHistory?.length || 0;
            const channelCount = cloudData.favoriteChannels?.length || 0;
            const messages = {
              ja: `ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (å‹•ç”»: ${historyCount}ä»¶, ãƒãƒ£ãƒ³ãƒãƒ«: ${channelCount}ä»¶)`,
              en: `Data loaded (Videos: ${historyCount}, Channels: ${channelCount})`,
              zh: `æ•°æ®å·²åŠ è½½ (è§†é¢‘: ${historyCount}æ¡, é¢‘é“: ${channelCount}ä¸ª)`
            };
            window.showNotification(messages[lang], 'success');
          }
        }, 500);
        
        // å¦‚æœè¯­è¨€æˆ–ä¸»é¢˜æ”¹å˜äº†ï¼Œéœ€è¦åˆ·æ–°é¡µé¢ï¼ˆåªåˆ·æ–°ä¸€æ¬¡ï¼‰
        if (!skipReload) {
          const needsReload = sessionStorage.getItem('needsReload');
          if (needsReload === 'true') {
            sessionStorage.removeItem('needsReload');
            sessionStorage.removeItem('dataLoaded'); // æ¸…é™¤åŠ è½½æ ‡è®°ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç™»å½•æ—¶é‡æ–°åŠ è½½
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        }
        
      } else {
        // é¦–æ¬¡ç™»å½•ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
        console.log('ğŸ“¤ é¦–æ¬¡ç™»å½•ï¼Œæ­£åœ¨ä¸Šä¼ æœ¬åœ°æ•°æ®...');
        await syncUserData(user);
        sessionStorage.setItem('dataLoaded', 'true');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
  }

  // Auth state observer
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // User is signed in
      console.log('User is signed in:', user.displayName);
      
      // Update UI
      loginButton.style.display = 'none';
      userProfile.style.display = 'flex';
      userAvatar.src = user.photoURL || 'img/default-avatar.png';
      userAvatarMenu.src = user.photoURL || 'img/default-avatar.png';
      userNameMenu.textContent = user.displayName || 'User';
      userEmailMenu.textContent = user.email || '';

      // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡æ•°æ®ï¼ˆé˜²æ­¢é‡å¤åŠ è½½ï¼‰
      const dataLoaded = sessionStorage.getItem('dataLoaded');
      if (dataLoaded !== 'true') {
        // Load user data from cloud
        await loadUserData(user);
      } else {
        console.log('æ•°æ®å·²åŠ è½½ï¼Œè·³è¿‡é‡å¤åŠ è½½');
      }
    } else {
      // User is signed out
      console.log('User is signed out');
      
      // æ¸…é™¤æ•°æ®åŠ è½½æ ‡è®°
      sessionStorage.removeItem('dataLoaded');
      sessionStorage.removeItem('needsReload');
      
      // Update UI
      loginButton.style.display = 'block';
      userProfile.style.display = 'none';
      userMenu?.classList.remove('show');
    }
  });

  // Make functions available globally
  window.syncUserData = syncUserData;
  window.loadUserData = loadUserData;

  // Helper function to get i18n text
  function getI18nText(key) {
    const lang = localStorage.getItem('selectedLanguage') || 'ja';
    const i18n = {
      ja: {
        login_success: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ',
        login_error: 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼',
        logout_success: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
        logout_error: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼',
        sync_success: 'ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ',
        sync_error: 'åŒæœŸã‚¨ãƒ©ãƒ¼',
        switch_success: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ',
        switch_error: 'åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼'
      },
      en: {
        login_success: 'Logged in successfully',
        login_error: 'Login error',
        logout_success: 'Logged out successfully',
        logout_error: 'Logout error',
        sync_success: 'Data synced successfully',
        sync_error: 'Sync error',
        switch_success: 'Account switched successfully',
        switch_error: 'Switch error'
      },
      zh: {
        login_success: 'ç™»å½•æˆåŠŸ',
        login_error: 'ç™»å½•é”™è¯¯',
        logout_success: 'ç™»å‡ºæˆåŠŸ',
        logout_error: 'ç™»å‡ºé”™è¯¯',
        sync_success: 'æ•°æ®åŒæ­¥æˆåŠŸ',
        sync_error: 'åŒæ­¥é”™è¯¯',
        switch_success: 'è´¦æˆ·åˆ‡æ¢æˆåŠŸ',
        switch_error: 'åˆ‡æ¢é”™è¯¯'
      }
    };
    return i18n[lang]?.[key] || i18n['ja'][key];
  }
</script>

</body>
</html>
