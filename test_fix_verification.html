<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复验证测试</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <h1>修复验证测试</h1>
    <button onclick="testFix()">测试修复</button>
    <div id="result"></div>

    <script>
        async function testFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '开始测试修复...';
            
            try {
                console.log('开始测试修复...');
                
                // 模拟频道配置
                const mezamashiChannel = {
                    name: "めざましテレビチャンネル（フジテレビ）",
                    url: "https://www.youtube.com/@mezamashitvchannel",
                    bakname: "mezamashitvchannel"
                };
                
                console.log('测试频道:', mezamashiChannel);
                
                // 工具：根据频道构造候选文件名
                const buildCandidates = (channel) => {
                    const candidates = [];
                    if (channel && channel.name) {
                        candidates.push(channel.name);
                        // 修复正则表达式，使用正确的括号
                        const baseName = channel.name.replace(/（[^）]*）$/, '').trim();
                        if (baseName && baseName !== channel.name) candidates.push(baseName);
                    }
                    if (channel && channel.bakname) {
                        const b = String(channel.bakname).trim();
                        if (b) candidates.push(b);
                    }
                    return [...new Set(candidates)];
                };

                // 工具：尝试加载某频道的JSON（包含修复）
                const loadChannelJson = async (channel) => {
                    const candidates = buildCandidates(channel);
                    
                    console.log('候选文件名:', candidates);
                    
                    for (const cand of candidates) {
                        const url = new URL('data/' + encodeURIComponent(cand) + '.json', window.location.href).pathname;
                        console.log('尝试加载文件:', url);
                        
                        try {
                            const r = await fetch(url);
                            if (r.ok) {
                                const data = await r.json();
                                console.log('成功加载频道数据:', cand, '视频数量:', data.videos?.length || 0);
                                return { data, source: url, resolvedName: cand };
                            } else {
                                console.log('文件加载失败:', url, '状态:', r.status);
                            }
                        } catch (error) {
                            console.log('文件加载错误:', url, error);
                        }
                    }
                    
                    // 如果所有候选文件名都失败，尝试直接加载mezamashitvchannel.json
                    if (channel.name && channel.name.includes('めざまし')) {
                        console.log('尝试直接加载mezamashitvchannel.json');
                        try {
                            const r = await fetch('data/mezamashitvchannel.json');
                            if (r.ok) {
                                const data = await r.json();
                                console.log('成功加载mezamashitvchannel.json，视频数量:', data.videos?.length || 0);
                                return { data, source: 'data/mezamashitvchannel.json', resolvedName: 'mezamashitvchannel' };
                            } else {
                                console.log('mezamashitvchannel.json加载失败，状态:', r.status);
                            }
                        } catch (error) {
                            console.log('mezamashitvchannel.json加载错误:', error);
                        }
                    }
                    
                    return null;
                };

                // 测试加载频道数据
                const loaded = await loadChannelJson(mezamashiChannel);
                if (!loaded) {
                    throw new Error('无法加载频道数据');
                }

                const videos = Array.isArray(loaded.data.videos) ? loaded.data.videos : [];
                console.log('频道视频数量:', videos.length);

                // 搜索匹配的视频
                const keyword = 'チャリメラ';
                const keywordMatches = videos.filter(v => v.title && v.title.toLowerCase().includes(keyword.toLowerCase()));
                console.log('匹配数量:', keywordMatches.length);

                if (keywordMatches.length > 0) {
                    resultDiv.innerHTML = `修复验证成功！找到 ${keywordMatches.length} 个匹配结果:<br>` + 
                        keywordMatches.map(v => `- ${v.title} (ID: ${v.id})`).join('<br>');
                } else {
                    resultDiv.innerHTML = `修复验证完成，但没有找到匹配的视频。<br>总视频数: ${videos.length}`;
                }
                
            } catch (error) {
                console.error('测试失败:', error);
                resultDiv.textContent = '测试失败: ' + error.message;
            }
        }
    </script>
</body>
</html>
