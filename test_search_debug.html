<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索功能调试测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #e8f4fd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .console-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>搜索功能调试测试</h1>
    
    <div class="test-section">
        <h3>测试搜索"チャリメラ"</h3>
        <p>点击下面的按钮测试搜索功能，然后查看浏览器控制台的输出。</p>
        <button class="test-button" onclick="testSearch()">开始搜索测试</button>
        <div id="searchResult" class="result">点击按钮开始测试...</div>
    </div>
    
    <div class="test-section">
        <h3>控制台输出</h3>
        <div id="consoleOutput" class="console-output">等待控制台输出...</div>
    </div>

    <script>
        // 捕获控制台输出
        const originalLog = console.log;
        const consoleOutput = document.getElementById('consoleOutput');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.textContent += message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        async function testSearch() {
            const resultDiv = document.getElementById('searchResult');
            resultDiv.textContent = '正在测试搜索功能...';
            
            try {
                // 模拟搜索功能
                const keyword = 'チャリメラ';
                console.log('开始搜索:', keyword);
                
                // 读取频道配置
                const resp = await fetch('japan_tv_youtube_channels.json');
                if (!resp.ok) throw new Error('频道配置加载失败');
                const channelsData = await resp.json();
                console.log('频道配置加载成功');

                // 展开为扁平化频道数组
                const allChannels = [];
                for (const region in channelsData) {
                    const categories = channelsData[region];
                    for (const category in categories) {
                        const list = categories[category];
                        if (Array.isArray(list)) {
                            for (const ch of list) {
                                allChannels.push(ch);
                            }
                        }
                    }
                }
                console.log('总频道数:', allChannels.length);

                // 查找めざまし频道
                const mezamashiChannel = allChannels.find(ch => ch.name && ch.name.includes('めざまし'));
                if (mezamashiChannel) {
                    console.log('找到めざまし频道:', mezamashiChannel);
                    
                    // 构建候选文件名
                    const candidates = [];
                    if (mezamashiChannel.name) {
                        candidates.push(mezamashiChannel.name);
                        const baseName = mezamashiChannel.name.replace(/（[^）]*）$/, '').trim();
                        if (baseName && baseName !== mezamashiChannel.name) {
                            candidates.push(baseName);
                        }
                    }
                    if (mezamashiChannel.bakname) {
                        candidates.push(mezamashiChannel.bakname);
                    }
                    console.log('候选文件名:', candidates);
                    
                    // 尝试加载文件
                    for (const candidate of candidates) {
                        const url = 'data/' + encodeURIComponent(candidate) + '.json';
                        console.log('尝试加载文件:', url);
                        
                        try {
                            const fileResp = await fetch(url);
                            if (fileResp.ok) {
                                const data = await fileResp.json();
                                console.log('文件加载成功:', candidate, '视频数量:', data.videos?.length || 0);
                                
                                // 搜索匹配的视频
                                const videos = data.videos || [];
                                console.log('开始搜索视频，总视频数:', videos.length);
                                
                                // 详细调试：检查前几个视频的标题
                                console.log('前5个视频标题:');
                                for (let i = 0; i < Math.min(5, videos.length); i++) {
                                    console.log(`  ${i+1}. ${videos[i].title}`);
                                }
                                
                                const matches = videos.filter(v => {
                                    if (!v.title) return false;
                                    const title = v.title.toLowerCase();
                                    const keywordLower = keyword.toLowerCase();
                                    const match = title.includes(keywordLower);
                                    if (match) {
                                        console.log('找到匹配:', v.title);
                                    }
                                    return match;
                                });
                                console.log('找到匹配视频:', matches.length);
                                
                                if (matches.length > 0) {
                                    resultDiv.textContent = `搜索成功！找到 ${matches.length} 个匹配结果:\n${matches.map(v => `- ${v.title} (ID: ${v.id})`).join('\n')}`;
                                } else {
                                    resultDiv.textContent = `搜索完成，但没有找到匹配的视频。\n搜索关键词: "${keyword}"\n总视频数: ${videos.length}`;
                                }
                                return;
                            } else {
                                console.log('文件加载失败:', url, '状态:', fileResp.status);
                            }
                        } catch (error) {
                            console.log('文件加载错误:', url, error);
                        }
                    }
                } else {
                    console.log('未找到めざまし频道');
                    resultDiv.textContent = '未找到めざまし频道配置';
                }
                
            } catch (error) {
                console.log('搜索测试失败:', error);
                resultDiv.textContent = '搜索测试失败: ' + error.message;
            }
        }
    </script>
</body>
</html>
